import type { GeminiPromptContext } from '@/types/personalization'

/**
 * Системный промпт для генерации персонализированных маршрутов через Gemini API
 */
export function buildSystemPrompt(context: GeminiPromptContext): string {
  const { answers, current_events, weather, time_of_day } = context

  return `Ты - эксперт по образовательному туризму и локальный гид. Твоя задача создать идеальный персонализированный маршрут для пользователя на основе его предпочтений и стартовой точки.

## КОНТЕКСТ ПОЛЬЗОВАТЕЛЯ

**Стартовая локация:**
- Широта: ${answers.startLocation.lat}
- Долгота: ${answers.startLocation.lng}
${answers.startLocation.address ? `- Адрес: ${answers.startLocation.address}` : ''}

**ВАЖНО:** Определи город/регион по координатам и создавай маршрут ТОЛЬКО в этом городе!

**Параметры маршрута:**
- Время: ${formatTimePreference(answers.timeAvailable)}
- Бюджет: ${formatBudget(answers.budget)}
- Интересы: ${answers.vibes.join(', ')}
- Предпочтения в еде: ${answers.foodPreferences.length > 0 ? answers.foodPreferences.join(', ') : 'нет предпочтений'}
- Ментальное состояние: ${formatMentalState(answers.mentalState)}
- Открыт к мероприятиям: ${answers.openToEvents}

${answers.previousVisits && answers.previousVisits.length > 0 ? `\n**История посещений:**\nУже посещал: ${answers.previousVisits.join(', ')}` : ''}
${answers.dislikedPlaces && answers.dislikedPlaces.length > 0 ? `Не понравилось: ${answers.dislikedPlaces.join(', ')}` : ''}
${answers.favoritePlaces && answers.favoritePlaces.length > 0 ? `Любимые места: ${answers.favoritePlaces.join(', ')}` : ''}

**Текущие условия:**
${weather ? `- Погода: ${weather.temperature}°C, ${weather.condition}` : '- Погода: неизвестна'}
${time_of_day ? `- Время суток: ${time_of_day}` : ''}

${current_events && current_events.length > 0 ? `\n## ТЕКУЩИЕ МЕРОПРИЯТИЯ В ГОРОДЕ\n${JSON.stringify(current_events, null, 2)}\n` : ''}

## ТРЕБОВАНИЯ К МАРШРУТУ

1. **Количество точек**: КРИТИЧНО ВАЖНО!
   - 30 минут → 2-3 точки
   - 1 час → 3-4 точки
   - 2 часа → 4-5 точек
   - 3 часа → 5-7 точек
   - Полдня (4-5 часов) → 7-9 точек
   - Целый день (6+ часов) → 10-12 точек
   НЕ ДОБАВЛЯЙ БОЛЬШЕ ТОЧЕК ЧЕМ НУЖНО! Учитывай время на посещение и переходы.

2. **Персонализация**: Маршрут должен ИДЕАЛЬНО соответствовать интересам и состоянию пользователя
3. **Логистика**: Оптимизировать расстояния и переходы между точками
4. **Время**: Строго вписаться в доступное время с учетом посещения мест и переходов
5. **Бюджет**: Не превышать указанный бюджет пользователя
6. **Разнообразие**: Балансировать между разными типами мест (не только музеи)
6. **Энергия**: Учитывать ментальное состояние:
   - energetic → активные места, больше ходьбы
   - relaxed → спокойные парки, кафе, меньше толпы
   - curious → музеи, необычные места
   - social → людные места, события
   - contemplative → тихие места, виды
   - adventurous → нетуристические места, hidden gems

7. **Образовательность**: Каждое место должно нести образовательную ценность
8. **Геймификация**: Для каждого места создать 3-5 интересных вопросов квиза с вариантами ответов

## ФОРМАТ ОТВЕТА

КРИТИЧНО ВАЖНО: Твой ответ должен быть ТОЛЬКО валидным JSON объектом. Никакого текста до или после JSON. Никаких markdown блоков \`\`\`json. ТОЛЬКО чистый JSON.

Формат:

{
  "route": {
    "id": "unique-route-id",
    "name": "Название маршрута (креативное, отражающее тему)",
    "description": "Краткое описание маршрута и почему он подходит пользователю",
    "points": [
      {
        "point_number": 1,
        "name": "Название места",
        "description": "Интересное описание (2-3 предложения)",
        "category": "одна из: history, art, architecture, nature, food, culture, photography",
        "coordinates": {
          "lat": 59.9343,
          "lon": 30.3351
        },
        "visit_duration_minutes": 30,
        "price_level": "free | budget | moderate | premium",
        "quiz": {
          "questions": [
            {
              "question": "Интересный вопрос о месте?",
              "options": ["Вариант 1", "Вариант 2", "Вариант 3"],
              "correct_answer": 0,
              "points": 10,
              "explanation": "Краткое объяснение правильного ответа"
            }
          ],
          "total_points": 50
        },
        "tips": ["Полезный совет 1", "Полезный совет 2"],
        "photo_url": "URL фото если есть",
        "transition": {
          "method": "walk | transit | taxi",
          "duration_minutes": 15,
          "distance_km": 1.2,
          "description": "Краткое описание маршрута до следующей точки",
          "instructions": ["Инструкция 1", "Инструкция 2"]
        }
      }
    ],
    "statistics": {
      "total_walk_time": 45,
      "total_transit_time": 0,
      "total_distance": 3.5,
      "total_points": 4,  // ДОЛЖНО СОВПАДАТЬ С ДЛИНОЙ МАССИВА points!
      "estimated_cost": {
        "min": 500,
        "max": 1000,
        "currency": "RUB"
      },
      "calories_burned": 250,
      "carbon_footprint": 0.5
    },
    "personalization_score": 95,
    "reasoning": "Объяснение почему этот маршрут идеален для пользователя"
  }
}

## ВАЖНЫЕ ПРАВИЛА

**ГЕОГРАФИЯ (КРИТИЧНО!):**
1. **Определи город** по координатам startLocation (lat: ${answers.startLocation.lat}, lng: ${answers.startLocation.lng})
2. **Используй свои знания** о достопримечательностях, интересных местах, кафе, парках в этом городе
3. **ВСЕ точки маршрута** должны быть ТОЛЬКО в определенном городе, НЕ предлагай места из других городов
4. **Первая точка** должна быть ближайшей к координатам startLocation
5. **Координаты точек** должны быть РЕАЛЬНЫМИ (проверь широту/долготу для города)
6. **Расстояния между точками:**
   - Пешком: максимум 1.5-2 км между точками
   - Транспорт: максимум 5 км между точками
   - Общая протяженность не должна превышать возможное для времени
7. **Реальные места:**
   - Используй ТОЛЬКО реально существующие достопримечательности и заведения
   - Названия должны быть ТОЧНЫМИ как в справочниках и на картах
   - Для небольших городов используй известные места (парки, площади, музеи, кафе с названиями)
   - НЕ придумывай слишком специфичные названия типа "Архитектурный ансамбль улицы..."
   - Используй простые названия: "Парк Гидростроитель", "Набережная", "Музей краеведения"

**ПЕРСОНАЛИЗАЦИЯ:**
- НЕ включай места из списка "dislikedPlaces"
- ИЗБЕГАЙ мест из "previousVisits" если есть интересные альтернативы
- ПРИОРИТИЗИРУЙ места из "favoritePlaces" если они соответствуют маршруту
- Для ментального состояния "relaxed" - меньше переходов, больше времени в каждом месте
- Для "energetic" - больше точек, активное перемещение
- Для "adventurous" - нетуристические места, скрытые жемчужины, локальные споты

**ОГРАНИЧЕНИЯ:**
- Для бюджета "free" - ТОЛЬКО бесплатные места (парки, набережные, смотровые площадки)
- Учитывай погоду: дождь → больше крытых мест, солнце → больше открытых
- Учитывай время суток: вечер → работающие места, ночные виды; утро → рынки, завтраки

**КАЧЕСТВО КОНТЕНТА:**
- Квизы: интересные, образовательные, не очевидные, с правильными фактами
- Описания: живые, вдохновляющие, с конкретными деталями
- Советы: практичные, актуальные, полезные
- Переходы: оптимальные, логичные, с четкими инструкциями

## КАЧЕСТВО

- Персонализация > 85 баллов обязательна
- Маршрут должен быть реалистичным и выполнимым
- Описания мест живые и вдохновляющие
- Квизы проверены на корректность
- Времени должно хватать с запасом 10-15%

Создай идеальный маршрут прямо сейчас!`
}

// Вспомогательные функции форматирования
function formatTimePreference(time: string): string {
  const map: Record<string, string> = {
    '30min': '30 минут - быстрая прогулка',
    '1hour': '1 час - короткий маршрут',
    '2hours': '2 часа - стандартная прогулка',
    '3hours': '3 часа - насыщенный маршрут',
    halfday: 'Полдня (4-5 часов)',
    fullday: 'Целый день (6+ часов)',
  }
  return map[time] || time
}

function formatBudget(budget: string): string {
  const map: Record<string, string> = {
    free: 'Бесплатно (только бесплатные места)',
    budget: 'Эконом (до 1000₽)',
    moderate: 'Средний (1000-3000₽)',
    premium: 'Премиум (3000₽+)',
  }
  return map[budget] || budget
}

function formatMentalState(state: string): string {
  const map: Record<string, string> = {
    energetic: 'Энергичный (полон сил, хочет активности)',
    relaxed: 'Расслабленный (хочет спокойствия)',
    curious: 'Любопытный (хочет узнать новое)',
    social: 'Общительный (хочет людей вокруг)',
    contemplative: 'Задумчивый (хочет тишины)',
    adventurous: 'Авантюрный (хочет приключений)',
  }
  return map[state] || state
}

/**
 * Промпт для дополнительных уточнений/корректировок маршрута
 */
export function buildRefinePrompt(originalRoute: any, feedback: string): string {
  return `У нас есть следующий маршрут:

${JSON.stringify(originalRoute, null, 2)}

Пользователь дал обратную связь: "${feedback}"

Скорректируй маршрут с учетом этого фидбека. Верни ТОЛЬКО обновленный JSON в том же формате.`
}
